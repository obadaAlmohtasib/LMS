{% load static %}
<!-- Load... -->
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <link href="{% static 'css/base.css' %}" rel="stylesheet" />
    <link href="{% static 'css/table.css' %}" rel="stylesheet" />
    <style>
      @media screen {
        .report-header {
          display: none;
        }
        .report-footer {
          display: none;
        }
      }
      @media print {
        @page {
          size: A4 landscape;
          margin: 0mm 0mm 0mm 0mm;
        }
        body {
          background: transparent;
        }
        h2,
        .print-func-holder,
        .screen-view-h3 {
          display: none;
        }
      }
      table {
        direction: rtl;
        font: 17px Calibri;
      }
      th,
      .fl-table td {
        font-size: 17px;
      }
      table,
      th,
      td {
        background-color: transparent;
        border: solid 1px #ddd;
        border-collapse: collapse;
        padding: 2px 3px;
        text-align: center;
      }
      table thead tr {
        background: #000;
        color: white;
      }
    </style>
  </head>
  <body>
    <h2 style="text-align: center">
      <span dir="auto">{{ course_name }}</span> التقرير الملخّص لِ
    </h2>

    <!-- Print Functionality -->
    <div class="print-func-holder">
      <!-- <div>
        <label for="week">Choose Week: </label>
        <input list="weeks" name="week" id="week" />
        <datalist id="weeks">
          {% for i in weeks_count %}
          <option value="Week-{{ i }}"></option>
          {% endfor %}
        </datalist>
      </div> -->
      <div>
        <button type="button" id="print_btn" class="print-action">طباعة</button>
      </div>
    </div>

    <!-- Report Summary -->
    <div>
      {% for week, days in report.items %}
      <div class="table-page-container">
        {% with object=days|get_object_simple %}
        <!-- Header -->
        <header class="report-header">
          <div
            style="
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
            "
          >
            <h3>Course name: {{ course_name }}</h3>
            <h3>Week number: #{{ object.week_number }}</h3>
          </div>
          <!-- <img src="{% static 'image/logo.png' %}" alt='logo' width=120 height=120></img> -->
        </header>

        <h3 class="screen-view-h3" style="text-align: center">
          Week #{{ object.week_number }}
        </h3>
        {% endwith %}
        <div class="table-wrapper" id="Week-{{week}}">
          <table class="fl-table">
            <thead>
              <tr>
                {% for head in days|get_keys %}
                <th>{{head}}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for cell in days|iter_greater_length %}
              <tr>
                {% for i in "0" %}
                <!-- arg_1 | filter_1:arg_2 | filter_2:arg_3 -->
                <td>{{ days|get_day:0|return_item:cell }}</td>
                <td>{{ days|get_day:1|return_item:cell }}</td>
                <td>{{ days|get_day:2|return_item:cell }}</td>
                <td>{{ days|get_day:3|return_item:cell }}</td>
                <td>{{ days|get_day:4|return_item:cell }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Footer  -->
        <footer class="report-footer">
          <pre></pre>
        </footer>
      </div>

      <!-- Page Break -->
      <p style="page-break-after: always"></p>

      {% endfor %}
    </div>
  </body>
  <script>
    // NOTE:
    // We've have to loop over table columns, and not over table rows
    // Filling the table column by column
    // console.log("Table - Column By Column");
    // Access Specific column
    // document.querySelectorAll("table[data-week='1'] th").forEach((el) => {
    //   console.log(el.innerText);
    // });

    // Set custom data attribute
    // document
    //   .querySelectorAll("table[data-week='1'] td[data-day='Sat']")
    //   .forEach((el) => {
    //     console.log(el.innerText);
    //   });

    document.querySelectorAll("th").forEach((el) => {
      const miladi_date = el.textContent;
      const hijri = new Date(miladi_date).toLocaleDateString("ar-SA", {
        weekday: "long",
        year: "numeric",
        month: "numeric",
        day: "2-digit",
      });
      if (hijri === "Invalid Date") return;

      const [day, hijri_date] = hijri.split("،");

      // lang.en,dates = miladi_date
      // lang.ar.dates = hijri_date

      // On the standard Arabic keyboard layout, The comma used for text is Shift+k
      // To embed HTML element properly into another element you've to use innerHTML (Do not use textContent)
      el.innerHTML = [day, miladi_date].join("<br>"); // Be careful (against attacks)
    });

    //
    // Print Functionality
    document.querySelector("#print_btn").addEventListener("click", function () {
      return window.print();

      // All this ignored
      let table_id = document.querySelector("input[id=week]").value;
      if (!table_id) return;
      let table = document.querySelector(`div[id=${table_id}]`)?.innerHTML;
      createPDF(table);
    });

    function createPDF(table) {
      let sTable = table;

      let style = "<style>";
      style = style + "table {width: 100%;font: 17px Calibri;}";
      style =
        style +
        "table, th, td {border: solid 1px #DDD; border-collapse: collapse;";
      style = style + "padding: 2px 3px;text-align: center;}";
      style = style + "table tbody tr:nth-of-type(odd) { background: #EEEEEE;}";
      style = style + "table thead tr { background: #000; color: white; }";
      style = style + "</style>";

      // CREATE A WINDOW OBJECT.
      let win = window.open("", "", "height=700,width=700");

      win.document.write("<html><head>");
      win.document.write("<title>Profile</title>"); // <title> FOR PDF HEADER.
      win.document.write(style); // ADD STYLE INSIDE THE HEAD TAG.
      win.document.write("</head>");
      win.document.write("<body>");
      win.document.write(sTable); // THE TABLE CONTENTS INSIDE THE BODY TAG.
      win.document.write("</body></html>");

      win.document.close(); // CLOSE THE CURRENT WINDOW.

      win.print(); // PRINT THE CONTENTS.
    }
  </script>
</html>
